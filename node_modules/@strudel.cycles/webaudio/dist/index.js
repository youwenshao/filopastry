"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const B=require("@strudel.cycles/core"),pe=require("nanostores");function he(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const j=he(B);if(typeof DelayNode<"u"){class e extends DelayNode{constructor(n,o,i,c){super(n),o=Math.abs(o),this.delayTime.value=i;const a=n.createGain();a.gain.value=Math.min(Math.abs(c),.995),this.feedback=a.gain;const r=n.createGain();return r.gain.value=o,this.delayGain=r,this.connect(a),this.connect(r),a.connect(this),this.connect=s=>r.connect(s),this}start(n){this.delayGain.gain.setValueAtTime(this.delayGain.gain.value,n+this.delayTime.value)}}AudioContext.prototype.createFeedbackDelay=function(t,n,o){return new e(this,t,n,o)}}typeof AudioContext<"u"&&(AudioContext.prototype.impulseResponse=function(e,t=1){const n=this.sampleRate*e,o=this.createBuffer(t,n,this.sampleRate),i=o.getChannelData(0);for(let c=0;c<n;c++)i[c]=(2*Math.random()-1)*Math.pow(1-c/n,e);return o},AudioContext.prototype.createReverb=function(e){const t=this.createConvolver();return t.setDuration=n=>(t.buffer=this.impulseResponse(n),t.duration=e,t),t.setDuration(e),t});var ne={a:{freqs:[660,1120,2750,3e3,3350],gains:[1,.5012,.0708,.0631,.0126],qs:[80,90,120,130,140]},e:{freqs:[440,1800,2700,3e3,3300],gains:[1,.1995,.1259,.1,.1],qs:[70,80,100,120,120]},i:{freqs:[270,1850,2900,3350,3590],gains:[1,.0631,.0631,.0158,.0158],qs:[40,90,100,120,120]},o:{freqs:[430,820,2700,3e3,3300],gains:[1,.3162,.0501,.0794,.01995],qs:[40,80,100,120,120]},u:{freqs:[370,630,2750,3e3,3400],gains:[1,.1,.0708,.0316,.01995],qs:[40,60,100,120,120]}};if(typeof GainNode<"u"){class e extends GainNode{constructor(n,o){if(super(n),!ne[o])throw new Error("vowel: unknown vowel "+o);const{gains:i,qs:c,freqs:a}=ne[o],r=n.createGain();for(let s=0;s<5;s++){const g=n.createGain();g.gain.value=i[s];const u=n.createBiquadFilter();u.type="bandpass",u.Q.value=c[s],u.frequency.value=a[s],this.connect(u),u.connect(g),g.connect(r)}return r.gain.value=8,this.connect=s=>r.connect(s),this}}AudioContext.prototype.createVowelFilter=function(t){return new e(this,t)}}const be="data:application/javascript;base64,Ly8gTElDRU5TRSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSB2My4wIHNlZSBodHRwczovL2dpdGh1Yi5jb20vZGt0cjAvV2ViRGlydC9ibG9iL21haW4vTElDRU5TRQovLyBhbGwgdGhlIGNyZWRpdCBnb2VzIHRvIGRrdHIwJ3Mgd2ViZGlydDogaHR0cHM6Ly9naXRodWIuY29tL2RrdHIwL1dlYkRpcnQvYmxvYi81Y2UzZDY5ODM2MmM1NGQ2ZTFiNjhhY2M0N2ViMjk1NWFjNjJjNzkzL2Rpc3QvQXVkaW9Xb3JrbGV0cy5qcwovLyA8MwoKY2xhc3MgQ29hcnNlUHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICBzdGF0aWMgZ2V0IHBhcmFtZXRlckRlc2NyaXB0b3JzKCkgewogICAgcmV0dXJuIFt7IG5hbWU6ICdjb2Fyc2UnLCBkZWZhdWx0VmFsdWU6IDEgfV07CiAgfQoKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLm5vdFN0YXJ0ZWQgPSB0cnVlOwogIH0KCiAgcHJvY2VzcyhpbnB1dHMsIG91dHB1dHMsIHBhcmFtZXRlcnMpIHsKICAgIGNvbnN0IGlucHV0ID0gaW5wdXRzWzBdOwogICAgY29uc3Qgb3V0cHV0ID0gb3V0cHV0c1swXTsKICAgIGNvbnN0IGNvYXJzZSA9IHBhcmFtZXRlcnMuY29hcnNlOwogICAgY29uc3QgYmxvY2tTaXplID0gMTI4OwogICAgY29uc3QgaGFzSW5wdXQgPSAhKGlucHV0WzBdID09PSB1bmRlZmluZWQpOwogICAgaWYgKGhhc0lucHV0KSB7CiAgICAgIHRoaXMubm90U3RhcnRlZCA9IGZhbHNlOwogICAgICBvdXRwdXRbMF1bMF0gPSBpbnB1dFswXVswXTsKICAgICAgZm9yIChsZXQgbiA9IDE7IG4gPCBibG9ja1NpemU7IG4rKykgewogICAgICAgIGZvciAobGV0IG8gPSAwOyBvIDwgb3V0cHV0Lmxlbmd0aDsgbysrKSB7CiAgICAgICAgICBvdXRwdXRbb11bbl0gPSBuICUgY29hcnNlID09IDAgPyBpbnB1dFswXVtuXSA6IG91dHB1dFtvXVtuIC0gMV07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5ub3RTdGFydGVkIHx8IGhhc0lucHV0OwogIH0KfQoKcmVnaXN0ZXJQcm9jZXNzb3IoJ2NvYXJzZS1wcm9jZXNzb3InLCBDb2Fyc2VQcm9jZXNzb3IpOwoKY2xhc3MgQ3J1c2hQcm9jZXNzb3IgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3IgewogIHN0YXRpYyBnZXQgcGFyYW1ldGVyRGVzY3JpcHRvcnMoKSB7CiAgICByZXR1cm4gW3sgbmFtZTogJ2NydXNoJywgZGVmYXVsdFZhbHVlOiAwIH1dOwogIH0KCiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5ub3RTdGFydGVkID0gdHJ1ZTsKICB9CgogIHByb2Nlc3MoaW5wdXRzLCBvdXRwdXRzLCBwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBpbnB1dCA9IGlucHV0c1swXTsKICAgIGNvbnN0IG91dHB1dCA9IG91dHB1dHNbMF07CiAgICBjb25zdCBjcnVzaCA9IHBhcmFtZXRlcnMuY3J1c2g7CiAgICBjb25zdCBibG9ja1NpemUgPSAxMjg7CiAgICBjb25zdCBoYXNJbnB1dCA9ICEoaW5wdXRbMF0gPT09IHVuZGVmaW5lZCk7CiAgICBpZiAoaGFzSW5wdXQpIHsKICAgICAgdGhpcy5ub3RTdGFydGVkID0gZmFsc2U7CiAgICAgIGlmIChjcnVzaC5sZW5ndGggPT09IDEpIHsKICAgICAgICBjb25zdCB4ID0gTWF0aC5wb3coMiwgY3J1c2hbMF0gLSAxKTsKICAgICAgICBmb3IgKGxldCBuID0gMDsgbiA8IGJsb2NrU2l6ZTsgbisrKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IE1hdGgucm91bmQoaW5wdXRbMF1bbl0gKiB4KSAvIHg7CiAgICAgICAgICBmb3IgKGxldCBvID0gMDsgbyA8IG91dHB1dC5sZW5ndGg7IG8rKykgewogICAgICAgICAgICBvdXRwdXRbb11bbl0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCBibG9ja1NpemU7IG4rKykgewogICAgICAgICAgbGV0IHggPSBNYXRoLnBvdygyLCBjcnVzaFtuXSAtIDEpOwogICAgICAgICAgY29uc3QgdmFsdWUgPSBNYXRoLnJvdW5kKGlucHV0WzBdW25dICogeCkgLyB4OwogICAgICAgICAgZm9yIChsZXQgbyA9IDA7IG8gPCBvdXRwdXQubGVuZ3RoOyBvKyspIHsKICAgICAgICAgICAgb3V0cHV0W29dW25dID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5ub3RTdGFydGVkIHx8IGhhc0lucHV0OwogIH0KfQpyZWdpc3RlclByb2Nlc3NvcignY3J1c2gtcHJvY2Vzc29yJywgQ3J1c2hQcm9jZXNzb3IpOwoKY2xhc3MgU2hhcGVQcm9jZXNzb3IgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3IgewogIHN0YXRpYyBnZXQgcGFyYW1ldGVyRGVzY3JpcHRvcnMoKSB7CiAgICByZXR1cm4gW3sgbmFtZTogJ3NoYXBlJywgZGVmYXVsdFZhbHVlOiAwIH1dOwogIH0KCiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5ub3RTdGFydGVkID0gdHJ1ZTsKICB9CgogIHByb2Nlc3MoaW5wdXRzLCBvdXRwdXRzLCBwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBpbnB1dCA9IGlucHV0c1swXTsKICAgIGNvbnN0IG91dHB1dCA9IG91dHB1dHNbMF07CiAgICBjb25zdCBzaGFwZTAgPSBwYXJhbWV0ZXJzLnNoYXBlWzBdOwogICAgY29uc3Qgc2hhcGUxID0gc2hhcGUwIDwgMSA/IHNoYXBlMCA6IDEuMCAtIDRlLTEwOwogICAgY29uc3Qgc2hhcGUgPSAoMi4wICogc2hhcGUxKSAvICgxLjAgLSBzaGFwZTEpOwogICAgY29uc3QgYmxvY2tTaXplID0gMTI4OwogICAgY29uc3QgaGFzSW5wdXQgPSAhKGlucHV0WzBdID09PSB1bmRlZmluZWQpOwogICAgaWYgKGhhc0lucHV0KSB7CiAgICAgIHRoaXMubm90U3RhcnRlZCA9IGZhbHNlOwogICAgICBmb3IgKGxldCBuID0gMDsgbiA8IGJsb2NrU2l6ZTsgbisrKSB7CiAgICAgICAgY29uc3QgdmFsdWUgPSAoKDEgKyBzaGFwZSkgKiBpbnB1dFswXVtuXSkgLyAoMSArIHNoYXBlICogTWF0aC5hYnMoaW5wdXRbMF1bbl0pKTsKICAgICAgICBmb3IgKGxldCBvID0gMDsgbyA8IG91dHB1dC5sZW5ndGg7IG8rKykgewogICAgICAgICAgb3V0cHV0W29dW25dID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5ub3RTdGFydGVkIHx8IGhhc0lucHV0OwogIH0KfQoKcmVnaXN0ZXJQcm9jZXNzb3IoJ3NoYXBlLXByb2Nlc3NvcicsIFNoYXBlUHJvY2Vzc29yKTsK";function Y(e){const t=I().createGain();return t.gain.value=e,t}const re=({s:e,freq:t,t:n})=>{const o=I().createOscillator();return o.type=e||"triangle",o.frequency.value=Number(t),o.start(n),{node:o,stop:c=>o.stop(c)}},U=(e,t,n,o,i,c)=>{const a=I().createGain();return a.gain.setValueAtTime(0,c),a.gain.linearRampToValueAtTime(i,c+e),a.gain.linearRampToValueAtTime(n*i,c+e+t),{node:a,stop:r=>{a.gain.setValueAtTime(n*i,r),a.gain.linearRampToValueAtTime(0,r+o)}}},Be=(e,t,n,o,i,c,a)=>{const r=I().createGain();return r.gain.setValueAtTime(0,c),r.gain.linearRampToValueAtTime(i,c+e),r.gain.linearRampToValueAtTime(n*i,c+e+t),r.gain.setValueAtTime(n*i,a),r.gain.linearRampToValueAtTime(0,a+o),r},O=(e,t,n)=>{const o=I().createBiquadFilter();return o.type=e,o.frequency.value=t,o.Q.value=n,o},{Pattern:me,logger:ae}=j,k=pe.map();function q(e,t,n={}){k.setKey(e,{onTrigger:t,data:n})}function E(e){return k.get()[e]}const ye=()=>k.set({});let x;const I=()=>(x||(x=new AudioContext),x);let W;const Q=()=>{const e=I();return W||(W=e.createGain(),W.connect(e.destination)),W},we=()=>{Q().gain.linearRampToValueAtTime(0,I().currentTime+.01),W=null};let M;function Ge(){return M||(M=I().audioWorklet.addModule(be),M)}function L(e,t,n){const o=new AudioWorkletNode(e,t);return Object.entries(n).forEach(([i,c])=>{o.parameters.get(i).value=c}),o}async function se(){if(typeof window<"u")try{await I().resume(),await Ge()}catch(e){console.warn("could not load AudioWorklet effects coarse, crush and shape",e)}}async function Xe(){return new Promise(e=>{document.addEventListener("click",async function t(){await se(),e(),document.removeEventListener("click",t)})})}let G={};const oe=.98;function Re(e,t,n,o){if(n>oe&&ae(`delayfeedback was clamped to ${oe} to save your ears`),n=j.clamp(n,0,.98),!G[e]){const c=I().createFeedbackDelay(1,t,n);c.start?.(o),c.connect(Q()),G[e]=c}return G[e].delayTime.value!==t&&G[e].delayTime.setValueAtTime(t,o),G[e].feedback.value!==n&&G[e].feedback.setValueAtTime(n,o),G[e]}let X={};function Ve(e,t=2){if(!X[e]){const o=I().createReverb(t);o.connect(Q()),X[e]=o}return X[e].duration!==t&&(X[e]=X[e].setDuration(t),X[e].duration=t),X[e]}function ce(e,t,n){const o=Y(n);return e.connect(o),o.connect(t),o}const $=async(e,t,n,o)=>{const i=I();e.ensureObjectValue();let c=i.currentTime+t,{s:a="triangle",bank:r,source:s,gain:g=.8,cutoff:u,resonance:h=1,hcutoff:f,hresonance:m=1,bandf:A,bandq:b=1,coarse:C,crush:y,shape:H,pan:K,vowel:F,delay:S=0,delayfeedback:R=.5,delaytime:l=.25,orbit:z=1,room:D,size:V=2}=e.value;const{velocity:J=1}=e.context;g*=J;let v=[];const ee=()=>{v.forEach(p=>p?.disconnect())};r&&a&&(a=`${r}_${a}`);let w;if(s)w=s(c,e.value,n);else if(E(a)){const{onTrigger:p}=E(a),N=await p(c,e.value,ee);N&&(w=N.node,N.stop(c+n))}else throw new Error(`sound ${a} not found! Is it loaded?`);if(!w)return;if(i.currentTime>c){ae("[webaudio] skip hap: still loading",i.currentTime-c);return}const d=[];if(d.push(w),d.push(Y(g)),u!==void 0&&d.push(O("lowpass",u,h)),f!==void 0&&d.push(O("highpass",f,m)),A!==void 0&&d.push(O("bandpass",A,b)),F!==void 0&&d.push(i.createVowelFilter(F)),C!==void 0&&d.push(L(i,"coarse-processor",{coarse:C})),y!==void 0&&d.push(L(i,"crush-processor",{crush:y})),H!==void 0&&d.push(L(i,"shape-processor",{shape:H})),K!==void 0){const p=i.createStereoPanner();p.pan.value=2*K-1,d.push(p)}const T=Y(1);d.push(T),T.connect(Q());let Z;if(S>0&&l>0&&R>0){const p=Re(z,l,R,c);Z=ce(T,p,S)}let te;if(D>0&&V>0){const p=Ve(z,V);te=ce(T,p,D)}d.slice(1).reduce((p,N)=>p.connect(N),d[0]),v=d.concat([Z,te])},ge=(e,t,n,o)=>$(t,e-n,t.duration/o);me.prototype.webaudio=function(){return this.onTrigger(ge)};function ve(e={}){e={getTime:()=>I().currentTime,defaultOutput:$,...e};const{defaultOutput:t,getTime:n}=e;return new j.Cyclist({...e,onTrigger:j.getTrigger({defaultOutput:t,getTime:n})})}const _={},P={},Te=e=>_[e];function Ze(e,t){var n=t?1e3:1024;if(e<n)return e+" B";var o=t?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],i=-1;do e/=n,++i;while(e>=n);return e.toFixed(1)+" "+o[i]}const de=async(e,t,n,o,i,c,a)=>{let r=0;i!==void 0&&n!==void 0&&B.logger("[sampler] hap has note and freq. ignoring note","warning");let s=B.valueToMidi({freq:i,note:n},36);r=s-36;const g=I();let u;if(Array.isArray(c))u=c[t%c.length];else{const A=C=>B.noteToMidi(C)-s,b=Object.keys(c).filter(C=>!C.startsWith("_")).reduce((C,y,H)=>!C||Math.abs(A(y))<Math.abs(A(C))?y:C,null);r=-A(b),u=c[b][t%c[b].length]}a&&(u=await a(u));let h=await ue(u,g,e,t);o<0&&(h=le(h));const f=g.createBufferSource();f.buffer=h;const m=1*Math.pow(2,r/12);return f.playbackRate.value=m,f},ue=(e,t,n,o=0)=>{const i=n?`sound "${n}:${o}"`:"sample";if(!P[e]){B.logger(`[sampler] load ${i}..`,"load-sample",{url:e});const c=Date.now();P[e]=fetch(e).then(a=>a.arrayBuffer()).then(async a=>{const r=Date.now()-c,s=Ze(a.byteLength);B.logger(`[sampler] load ${i}... done! loaded ${s} in ${r}ms`,"loaded-sample",{url:e});const g=await t.decodeAudioData(a);return _[e]=g,g})}return P[e]};function le(e){const t=I(),n=t.createBuffer(e.numberOfChannels,e.length,t.sampleRate);for(let o=0;o<e.numberOfChannels;o++)n.copyToChannel(e.getChannelData(o).slice().reverse(),o,o);return n}const He=e=>_[e],Ie=(e,t,n=e._base||"")=>Object.entries(e).forEach(([o,i])=>{if(typeof i=="string"&&(i=[i]),typeof i!="object")throw new Error("wrong sample map format for "+o);n=i._base||n;const c=a=>(n+a).replace("github:","https://raw.githubusercontent.com/");Array.isArray(i)?i=i.map(c):i=Object.fromEntries(Object.entries(i).map(([a,r])=>[a,(typeof r=="string"?[r]:r).map(c)])),t(o,i)});let Ce={};function Se(e,t){Ce[e]=t}function Ne(e){const t=Object.entries(Ce).find(([n])=>e.startsWith(n));if(t)return t[1]}const fe=async(e,t=e._base||"",n={})=>{if(typeof e=="string"){const c=Ne(e);if(c)return c(e);if(e.startsWith("github:")){let[r,s]=e.split("github:");s=s.endsWith("/")?s.slice(0,-1):s,e=`https://raw.githubusercontent.com/${s}/strudel.json`}if(typeof fetch!="function")return;const a=e.split("/").slice(0,-1).join("/");return typeof fetch>"u"?void 0:fetch(e).then(r=>r.json()).then(r=>fe(r,t||r._base||a,n)).catch(r=>{throw console.error(r),new Error(`error loading "${e}"`)})}const{prebake:o,tag:i}=n;Ie(e,(c,a)=>q(c,(r,s,g)=>Ae(r,s,g,a),{type:"sample",samples:a,baseUrl:t,prebake:o,tag:i}),t)},ie=[];async function Ae(e,t,n,o,i){const{s:c,freq:a,unit:r,nudge:s=0,cut:g,loop:u,clip:h=void 0,n:f=0,note:m,speed:A=1,begin:b=0,end:C=1}=t;if(A===0)return;const y=I(),{attack:H=.001,decay:K=.001,sustain:F=1,release:S=.001}=t,R=e+s,l=await de(c,f,m,A,a,o,i);if(y.currentTime>e){B.logger(`[sampler] still loading sound "${c}:${f}"`,"highlight");return}if(!l){B.logger(`[sampler] could not load "${c}:${f}"`,"error");return}l.playbackRate.value=Math.abs(A)*l.playbackRate.value,r==="c"&&(l.playbackRate.value=l.playbackRate.value*l.buffer.duration*1);const z=b*l.buffer.duration;l.start(R,z);const D=l.buffer.duration/l.playbackRate.value,{node:V,stop:J}=U(H,K,F,S,1,e);l.connect(V);const v=y.createGain();V.connect(v),l.onended=function(){l.disconnect(),V.disconnect(),v.disconnect(),n()};const w={node:v,bufferSource:l,stop:(d,T=h===void 0)=>{let Z=d;T&&(Z=e+(C-b)*D),l.stop(Z+S),J(Z)}};if(g!==void 0){const d=ie[g];d&&(d.node.gain.setValueAtTime(1,R),d.node.gain.linearRampToValueAtTime(0,R+.01)),ie[g]=w}return w}function We(){["sine","square","triangle","sawtooth"].forEach(e=>{q(e,(t,n,o)=>{const{attack:i=.001,decay:c=.05,sustain:a=.6,release:r=.01}=n;let{n:s,note:g,freq:u}=n;s=g||s||36,typeof s=="string"&&(s=B.noteToMidi(s)),!u&&typeof s=="number"&&(u=B.midiToFreq(s));const{node:h,stop:f}=re({t,s:e,freq:u}),m=Y(.3),{node:A,stop:b}=U(i,c,a,r,1,t);return h.onended=()=>{h.disconnect(),m.disconnect(),o()},{node:h.connect(m).connect(A),stop:C=>{b(C),f(C+r)}}},{type:"synth",prebake:!0})})}exports.gainNode=Y;exports.getADSR=Be;exports.getAudioContext=I;exports.getCachedBuffer=Te;exports.getEnvelope=U;exports.getFilter=O;exports.getLoadedBuffer=He;exports.getOscillator=re;exports.getSampleBufferSource=de;exports.getSound=E;exports.initAudio=se;exports.initAudioOnFirstClick=Xe;exports.loadBuffer=ue;exports.onTriggerSample=Ae;exports.panic=we;exports.processSampleMap=Ie;exports.registerSamplesPrefix=Se;exports.registerSound=q;exports.registerSynthSounds=We;exports.resetLoadedSounds=ye;exports.reverseBuffer=le;exports.samples=fe;exports.soundMap=k;exports.webaudioOutput=$;exports.webaudioOutputTrigger=ge;exports.webaudioScheduler=ve;
